# https://moonrepo.dev/docs/config/project
$schema: 'https://moonrepo.dev/schemas/project.json'

type: 'application'
language: 'rust'
stack: 'backend'
tags:
  - 'rust'
  - 'api'

fileGroups:
  sources:
    - 'src/**/*'
  cargo:
    - 'Cargo.toml'
    - 'Cargo.lock'

tasks:
  build:
    command: 'cargo'
    args:
      - 'build'
      - '--release'
    inputs:
      - '@group(sources)'
      - '@group(cargo)'
    outputs:
      - '/target/release/backend'

  dev:
    command: 'cargo'
    args: 'run'
    local: true
    options:
      persistent: true

  check:
    command: 'cargo'
    args: 'check'
    inputs:
      - '@group(sources)'
      - '@group(cargo)'

  test:
    command: 'cargo'
    args: 'test'
    inputs:
      - '@group(sources)'
      - '@group(cargo)'

  fmt:
    command: 'cargo'
    args: 'fmt'
    inputs:
      - '@group(sources)'
    local: true

  fmt-check:
    extends: 'fmt'
    args: '--check'
    local: false

  clippy:
    command: 'cargo'
    args:
      - 'clippy'
      - '--'
      - '-D'
      - 'warnings'
    inputs:
      - '@group(sources)'
      - '@group(cargo)'

  test-integration:
    command: 'cargo'
    args:
      - 'test'
      - '--test'
      - '*_test*'
      - '--test'
      - '*_tests'
      - '--'
      - '--test-threads=1'
    inputs:
      - '@group(sources)'
      - '@group(cargo)'
      - 'tests/**/*'
